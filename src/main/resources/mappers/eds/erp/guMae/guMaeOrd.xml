<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.springboot.myapp.eds.erp.controller.guMae.guMaeOrdMapper">

    <select id="selectOrdMgtList" resultType="com.springboot.myapp.eds.erp.vo.guMae.guMaeOrdListVO">
        SELECT /* selectOrdMgtList */
            T1.corpCd
            ,T1.busiCd
            ,(SELECT busiNm FROM TB_BASE_BUSI_LIST T0 WHERE T0.corpCd=T1.corpCd AND T0.busiCd=T1.busiCd) AS busiNm
            ,T1.estCd
            ,T1.projCd
            ,T1.ordCd
            ,T1.deadDivi
            ,T1.sccDivi
            ,(SELECT I1.projNm FROM TB_PROJECT_LIST I1 WHERE I1.corpCd=#{corpCd} AND I1.projCd like T1.projCd) AS projNm
            ,T1.estDt
            ,T1.ordDt
            ,T1.validDt
            ,T1.ordDueDt
            ,T1.custCd
            ,(SELECT I1.custNm FROM TB_BASE_CUST_LIST I1 WHERE I1.corpCd = #{corpCd} AND I1.custCd = T1.custCd) as custNm
            ,T1.manCd
            ,(SELECT I1.empNm FROM TB_BASE_USER_LIST I1 WHERE I1.corpCd = #{corpCd} AND I1.empCd = T1.manCd) as manNm
            ,manNote
            ,T1.depaCd
            ,(SELECT depaNm FROM TB_BASE_DEPA_LIST T0 WHERE T0.corpCd=#{corpCd} AND T0.depaCd=T1.depaCd) AS depaNm
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.supAmt ELSE SUM(T2.supAmt) END AS supAmt
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.vatAmt ELSE SUM(T2.vatAmt) END AS vatAmt
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.totAmt ELSE SUM(T2.totAmt) END AS totAmt
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.supAmt2 ELSE SUM(T2.supAmt2) END AS supAmt2
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.vatAmt2 ELSE SUM(T2.vatAmt2) END AS vatAmt2
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.totAmt2 ELSE SUM(T2.totAmt2) END AS totAmt2
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.supAmt3 ELSE SUM(T2.supAmt3) END AS supAmt3
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.vatAmt3 ELSE SUM(T2.vatAmt3) END AS vatAmt3
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.totAmt3 ELSE SUM(T2.totAmt3) END AS totAmt3
            ,T1.clas
            ,T1.item
            ,T1.payTm
            ,T1.note1
            ,T1.note2
            ,(SELECT empNm FROM TB_BASE_USER_LIST I1 WHERE I1.corpCd = #{corpCd} AND I1.empCd = T1.inpId) AS inpNm
            ,(SELECT empNm FROM TB_BASE_USER_LIST I1 WHERE I1.corpCd = #{corpCd} AND I1.empCd = T1.updId) AS updNm
          FROM TB_GUMAE_ORD_LIST T1
              LEFT JOIN TB_GUMAE_ORD_ITEM_LIST T2
                  ON T1.corpCd = T2.corpCd
                 AND T1.ordCd = T2.ordCd
              INNER JOIN tb_project_list T3
                  ON T1.corpCd = T3.corpCd
                 AND T1.projCd = T3.projCd
         WHERE T1.corpCd = #{corpCd}
        <if test="busiCd != null and !busiCd.equals('')">
            AND T1.busiCd = #{busiCd}
        </if>
        <if test="authDivi == '3' or authDivi.equals('3')">
           AND T1.depaCd = #{depaCd}
        </if>
        <if test="authDivi == '4' or authDivi.equals('4')">
           AND T1.depaCd = #{depaCd}
           AND T1.empCd = #{empCd}
        </if>
        <if test="projNm != null and !projNm.equals('')">
            AND T3.projNm like '%' #{projNm} '%'
        </if>
        AND T1.ordDt BETWEEN #{stDt} AND #{edDt}
        GROUP BY T1.corpCd, T1.busiCd, T1.ordCd
        ORDER BY T1.ordDt*1 DESC, T1.ordCd*1 DESC
    </select>

    <select id="selectOrdItemList" resultType="com.springboot.myapp.eds.erp.vo.guMae.guMaeOrdItemListVO">
        SELECT /* selectOrdItemList */
            corpCd
            ,busiCd
            ,estCd
            ,projCd
            ,ordCd
            ,seq
            ,itemCd
            ,(SELECT I1.itemNm FROM TB_BASE_ITEM_LIST I1 WHERE I1.corpCd = #{corpCd} AND I1.itemCd = T1.itemCd) as itemNm
            ,(SELECT I1.unit FROM TB_BASE_ITEM_LIST I1 WHERE I1.corpCd = #{corpCd} AND I1.itemCd = T1.itemCd) as unit
            ,standard
            ,vatDivi
            ,taxDivi
            ,qty
            ,cost
            ,supAmt
            ,vatAmt
            ,totAmt
            ,cost2
            ,supAmt2
            ,vatAmt2
            ,totAmt2
            ,cost3
            ,supAmt3
            ,vatAmt3
            ,totAmt3
            ,saleDivi
            ,saleRate
            ,note
            ,(SELECT empNm FROM TB_BASE_USER_LIST I1 WHERE I1.corpCd = #{corpCd} AND I1.empCd = T1.inpId) AS inpNm
            ,(SELECT empNm FROM TB_BASE_USER_LIST I1 WHERE I1.corpCd = #{corpCd} AND I1.empCd = T1.updId) AS updNm
          FROM TB_GUMAE_ORD_ITEM_LIST T1
         WHERE corpCd = #{corpCd}
           AND ordCd = #{ordCd}
        ORDER BY seq*1 ASC
    </select>
    
    <insert id="insertOrdMgtList" parameterType="hashMap">
        INSERT INTO /* insertOrdMgtList */
        TB_GUMAE_ORD_LIST(
            corpCd
            ,busiCd
            ,estCd
            ,projCd
            ,ordCd
            ,deadDivi
            ,sccDivi
            ,estDt
            ,ordDt
            ,validDt
            ,custCd
            ,manCd
            ,ordDueDt
            ,manNote
            ,depaCd
            ,supAmt2
            ,vatAmt2
            ,totAmt2
            ,supAmt3
            ,vatAmt3
            ,totAmt3
            ,clas
            ,item
            ,payTm
            ,note1
            ,note2
            ,inpId
            ,inpDttm
            ,updId
            ,updDttm
        )
        SELECT
            #{corpCd}
            ,#{busiCd}
            ,#{estCd}
            ,#{projCd}
            ,(SELECT
            CONCAT(DATE_FORMAT(now(),'%Y%m'),LPAD(IFNULL(SUBSTR(MAX(ordCd*1)+1,7,12),0),5,'0'))
            FROM TB_GUMAE_ORD_LIST
            WHERE corpCd = #{corpCd}
                AND DATE_FORMAT(now(),'%Y%m') = SUBSTR(ordCd,1,6))
            ,#{deadDivi}
            ,#{sccDivi}
            ,#{estDt}
            ,#{ordDt}
            ,#{validDt}
            ,#{custCd}
            ,#{manCd}
            ,#{ordDueDt}
            ,#{manNote}
            ,#{depaCd}
            ,#{supAmt2}
            ,#{vatAmt2}
            ,#{totAmt2}
            ,#{supAmt3}
            ,#{vatAmt3}
            ,#{totAmt3}
            ,#{clas}
            ,#{item}
            ,#{payTm}
            ,#{note1}
            ,#{note2}
            ,#{userId}
            ,now()
            ,#{userId}
            ,now()
        <selectKey keyColumn="ordCd" keyProperty="ordCd" order="AFTER" resultType="java.lang.String">
            SELECT ordCd
            FROM TB_GUMAE_ORD_LIST
            WHERE corpCd = #{corpCd}
            ORDER BY ordCd DESC
            LIMIT 1;
        </selectKey>
    </insert>

    <insert id="insertOrdItemList" parameterType="hashMap">
        INSERT INTO /* insertOrdItemList */
            TB_GUMAE_ORD_ITEM_LIST(
                                corpCd
                                ,busiCd
                                ,estCd
                                ,projCd
                                ,ordCd
                                ,seq
                                ,itemCd
                                ,vatDivi
                                ,taxDivi
                                ,qty
                                ,cost
                                ,supAmt
                                ,vatAmt
                                ,totAmt
                                ,cost2
                                ,supAmt2
                                ,vatAmt2
                                ,totAmt2
                                ,cost3
                                ,supAmt3
                                ,vatAmt3
                                ,totAmt3
                                ,saleDivi
                                ,saleRate
                                ,note
                                ,inpId
                                ,inpDttm
                                ,updId
                                ,updDttm
        )
        SELECT
            #{corpCd}
            ,#{busiCd}
            ,#{estCd}
            ,#{projCd}
            ,#{ordCd}
            ,(SELECT IFNULL(MAX(CAST(seq as signed)),0)+1
              FROM TB_GUMAE_ORD_ITEM_LIST
              WHERE corpCd = #{corpCd}
                AND ordCd = #{ordCd})
            ,#{itemCd}
            ,#{vatDivi}
            ,#{taxDivi}
            ,#{qty}
            ,#{cost}
            ,#{supAmt}
            ,#{vatAmt}
            ,#{totAmt}
            ,#{cost2}
            ,#{supAmt2}
            ,#{vatAmt2}
            ,#{totAmt2}
            ,#{cost3}
            ,#{supAmt3}
            ,#{vatAmt3}
            ,#{totAmt3}
            ,#{saleDivi}
            ,#{saleRate}
            ,#{note}
            ,#{userId}
            ,now()
            ,#{userId}
            ,now()
    </insert>

    <update id="updateOrdMgtList" parameterType="hashMap">
        UPDATE /* updateOrdMgtList */
        TB_GUMAE_ORD_LIST SET
            deadDivi = #{deadDivi}
            ,sccDivi = #{sccDivi}
            ,estDt = #{estDt}
            ,ordDt = #{ordDt}
            ,validDt = #{validDt}
            ,custCd = #{custCd}
            ,projCd = #{projCd}
            ,manCd = #{manCd}
            ,ordDueDt = #{ordDueDt}
            ,manNote = #{manNote}
            ,depaCd = #{depaCd}
            ,supAmt2 = #{supAmt2}
            ,vatAmt2 = #{vatAmt2}
            ,totAmt2 = #{totAmt2}
            ,supAmt3 = #{supAmt3}
            ,vatAmt3 = #{vatAmt3}
            ,totAmt3 = #{totAmt3}
            ,clas = #{clas}
            ,item = #{item}
            ,payTm = #{payTm}
            ,note1 = #{note1}
            ,note2 = #{note2}
            ,updId = #{userId}
            ,updDttm = now()
        WHERE corpCd = #{corpCd}
          AND ordCd = #{ordCd}
    </update>

    <update id="updateOrdItemList" parameterType="hashMap">
        UPDATE /* updateOrdItemList */
        TB_GUMAE_ORD_ITEM_LIST SET
            itemCd = #{itemCd}
            ,vatDivi = #{vatDivi}
            ,taxDivi = #{taxDivi}
            ,qty = #{qty}
            ,cost = #{cost}
            ,supAmt = #{supAmt}
            ,vatAmt = #{vatAmt}
            ,totAmt = #{totAmt}
            ,cost2 = #{cost2}
            ,supAmt2 = #{supAmt2}
            ,vatAmt2 = #{vatAmt2}
            ,totAmt2 = #{totAmt2}
            ,cost3 = #{cost3}
            ,supAmt3 = #{supAmt3}
            ,vatAmt3 = #{vatAmt3}
            ,totAmt3 = #{totAmt3}
            ,saleDivi = #{saleDivi}
            ,saleRate = #{saleRate}
            ,note = #{note}
            ,updId = #{userId}
            ,updDttm = now()
        WHERE corpCd = #{corpCd}
          AND ordCd = #{ordCd}
          AND seq = #{seq}
    </update>

    <delete id="deleteOrdMgtList"  parameterType="hashMap">
        DELETE /* deleteOrdMgtList */
        FROM TB_GUMAE_ORD_LIST
        WHERE corpCd = #{corpCd}
          AND ordCd = #{ordCd}
    </delete>

    <delete id="deleteOrdItemList"  parameterType="hashMap">
        DELETE /* deleteOrdItemList */
        FROM TB_GUMAE_ORD_ITEM_LIST
        WHERE corpCd = #{corpCd}
          AND ordCd = #{ordCd}
        <if test="seq != null and !seq.equals('')">
          AND seq = #{seq}
        </if>
    </delete>

    <delete id="deleteOrdEmailList"  parameterType="hashMap">
        DELETE /*deleteOrdEmailList*/
        FROM tb_guMae_ord_email_list
        WHERE corpCd = #{corpCd}
          AND ordCd = #{ordCd}
        <if test="seq != null and !seq.equals('')">
          AND seq = #{seq}
        </if>
    </delete>

    <insert id="aProjMgtList" parameterType="hashMap">
        INSERT INTO /* aPorjMgtList */
        TB_GUMAE_ORD_LIST(
            corpCd
            ,busiCd
            ,estCd
            ,projCd
            ,ordCd
            ,deadDivi
            ,sccDivi
            ,estDt
            ,validDt
            ,ordDt
            ,custCd
            ,manCd
            ,depaCd
            ,supAmt
            ,vatAmt
            ,totAmt
            ,supAmt2
            ,vatAmt2
            ,totAmt2
            ,supAmt3
            ,vatAmt3
            ,totAmt3
            ,clas
            ,item
            ,payTm
            ,note1
            ,note2
            ,inpId
            ,inpDttm
            ,updId
            ,updDttm
        )
        SELECT
            T1.corpCd
            ,T1.busiCd
            ,T1.estCd
            ,T1.projCd
            ,(SELECT CONCAT(DATE_FORMAT(now(),'%Y%m'),LPAD(IFNULL(SUBSTR(MAX(ordCd*1)+1,7,12),0),5,'0'))
                FROM TB_GUMAE_ORD_LIST
               WHERE corpCd = #{corpCd}
                 AND DATE_FORMAT(now(),'%Y%m') = SUBSTR(ordCd,1,6))
            ,T1.deadDivi
            ,T1.sccDivi
            ,T1.estDt
            ,T1.validDt
            ,DATE_FORMAT(now(), '%Y%m%d')
            ,''
            ,T1.manCd
            ,T1.depaCd
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.supAmt ELSE SUM(T2.supAmt) END AS supAmt
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.vatAmt ELSE SUM(T2.vatAmt) END AS vatAmt
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.totAmt ELSE SUM(T2.totAmt) END AS totAmt
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.supAmt2 ELSE SUM(T2.supAmt2) END AS supAmt2
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.vatAmt2 ELSE SUM(T2.vatAmt2) END AS vatAmt2
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.totAmt2 ELSE SUM(T2.totAmt2) END AS totAmt2
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.supAmt3 ELSE SUM(T2.supAmt3) END AS supAmt3
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.vatAmt3 ELSE SUM(T2.vatAmt3) END AS vatAmt3
            ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.totAmt3 ELSE SUM(T2.totAmt3) END AS totAmt3
            ,T1.clas
            ,T1.item
            ,''
            ,''
            ,''
            ,T1.inpId
            ,now()
            ,T1.updId
            ,now()
          FROM TB_PROJECT_LIST T1 LEFT JOIN TB_PROJECT_ITEM_LIST T2
            ON T1.corpCd = T2.corpCd
           AND T1.projCd = T2.projCd
         WHERE T1.corpCd = #{corpCd}
           AND T1.projCd = #{projCd}
         GROUP BY T1.corpCd, T1.projCd
        <selectKey keyColumn="ordCd" keyProperty="ordCd" order="AFTER" resultType="java.lang.String">
            SELECT ordCd
            FROM TB_GUMAE_ORD_LIST
            WHERE corpCd = #{corpCd}
            ORDER BY ordCd DESC
            LIMIT 1;
        </selectKey>
    </insert>

    <insert id="aProjItemList" parameterType="hashMap">
        INSERT INTO /* aProjItemList */
            TB_GUMAE_ORD_ITEM_LIST(
                                 corpCd
                                ,busiCd
                                ,estCd
                                ,projCd
                                ,ordCd
                                ,seq
                                ,itemCd
                                ,standard
                                ,vatDivi
                                ,taxDivi
                                ,qty
                                ,cost
                                ,supAmt
                                ,vatAmt
                                ,totAmt
                                ,cost2
                                ,supAmt2
                                ,vatAmt2
                                ,totAmt2
                                ,cost3
                                ,supAmt3
                                ,vatAmt3
                                ,totAmt3
                                ,saleDivi
                                ,saleRate
                                ,note
                                ,inpId
                                ,inpDttm
                                ,updId
                                ,updDttm
        )
        SELECT
            T1.corpCd
             ,T1.busiCd
             ,T1.estCd
             ,T1.projCd
             ,#{ordCd}
             ,T1.seq
             ,T1.itemCd
             ,T1.standard
             ,T1.vatDivi
             ,T1.taxDivi
             ,T1.qty
             ,T1.cost
             ,T1.supAmt
             ,T1.vatAmt
             ,T1.totAmt
             ,T1.cost2
             ,T1.supAmt2
             ,T1.vatAmt2
             ,T1.totAmt2
             ,T1.cost3
             ,T1.supAmt3
             ,T1.vatAmt3
             ,T1.totAmt3
             ,T1.saleDivi
             ,T1.saleRate
             ,''
             ,T1.inpId
             ,now()
             ,T1.updId
             ,now()
        FROM TB_PROJECT_ITEM_LIST T1
        WHERE T1.corpCd = #{corpCd}
          AND T1.projCd = #{projCd}
        ORDER BY seq*1 ASC
    </insert>

    <update id="deadLineOrdMgtList" parameterType="hashMap">
        UPDATE /*deadLineOrdMgtList*/
            TB_GUMAE_ORD_LIST SET
            deadDivi = #{deadDivi}
        WHERE corpCd = #{corpCd}
          AND ordCd = #{ordCd}
    </update>
</mapper>