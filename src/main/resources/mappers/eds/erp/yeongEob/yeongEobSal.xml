<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.springboot.myapp.eds.erp.controller.yeongEob.yeongEobSalMapper">

    <select id="selectSalMgtList" resultType="com.springboot.myapp.eds.erp.vo.yeongEob.yeongEobSalListVO">
        SELECT /* selectSalMgtList */
            T1.corpCd
            ,T1.busiCd
            ,(SELECT busiNm FROM TB_BASE_BUSI_LIST T0 WHERE T0.corpCd=T1.corpCd AND T0.busiCd=T1.busiCd) AS busiNm
            ,T1.estCd
            ,T1.projCd
            ,T1.salCd
            ,T1.projDivi
            ,T1.deadDivi
            ,T1.sccDivi
            ,T1.salDivi
            ,(SELECT I1.projNm FROM TB_PROJECT_LIST I1 WHERE I1.corpCd=#{corpCd} AND I1.projCd like T1.projCd) AS projNm
            ,T1.estDt
            ,T1.validDt
            ,T1.cntDt
            ,T1.dueDt
            ,T1.endDt
            ,T1.salDt
            ,T1.custCd
            ,(SELECT I1.custNm FROM TB_BASE_CUST_LIST I1 WHERE I1.corpCd = #{corpCd} AND I1.custCd = T1.custCd) as custNm
            ,T1.manCd
            ,(SELECT I1.empNm FROM TB_BASE_USER_LIST I1 WHERE I1.corpCd = #{corpCd} AND I1.empCd = T1.manCd) as manNm
            ,T1.depaCd
            ,(SELECT depaNm FROM TB_BASE_DEPA_LIST T0 WHERE T0.corpCd=#{corpCd} AND T0.depaCd=T1.depaCd) AS depaNm
            ,T1.supAmt2
            ,T1.vatAmt2
            ,T1.totAmt2
            ,T1.supAmt3
            ,T1.vatAmt3
            ,T1.totAmt3
            ,T1.clas
            ,T1.item
            ,T1.payTm
            ,T1.note1
            ,T1.note2
            ,(SELECT empNm FROM TB_BASE_USER_LIST I1 WHERE I1.corpCd = #{corpCd} AND I1.empCd = T1.inpId) AS inpNm
            ,(SELECT empNm FROM TB_BASE_USER_LIST I1 WHERE I1.corpCd = #{corpCd} AND I1.empCd = T1.updId) AS updNm
          FROM TB_YEONGEOB_SAL_LIST T1
         WHERE T1.corpCd = #{corpCd}
        <if test="busiCd != null and !busiCd.equals('')">
            AND T1.busiCd = #{busiCd}
        </if>
        <if test="authDivi == '3' or authDivi.equals('3')">
           AND T1.depaCd = #{depaCd}
        </if>
        <if test="authDivi == '4' or authDivi.equals('4')">
           AND T1.depaCd = #{depaCd}
           AND T1.empCd = #{empCd}
        </if>
        <if test="projNm != null and !projNm.equals('')">
            AND (SELECT I1.projNm FROM TB_PROJECT_LIST I1 WHERE I1.corpCd=#{corpCd} AND I1.projCd like T1.projCd) like '%' #{projNm} '%'
        </if>
        AND T1.salDt BETWEEN #{stDt} AND #{edDt}
        GROUP BY T1.corpCd, T1.busiCd, T1.salCd
        ORDER BY T1.salCd*1 DESC
    </select>
    
    <insert id="insertSalMgtList" parameterType="hashMap">
        INSERT INTO /* insertSalMgtList */
        TB_YEONGEOB_SAL_LIST(
            corpCd
            ,busiCd
            ,estCd
            ,projCd
            ,salCd
            ,deadDivi
            ,projDivi
            ,sccDivi
            ,salDivi
            ,estDt
            ,validDt
            ,cntDt
            ,dueDt
            ,endDt
            ,salDt
            ,custCd
            ,manCd
            ,depaCd
            ,supAmt2
            ,vatAmt2
            ,totAmt2
            ,supAmt3
            ,vatAmt3
            ,totAmt3
            ,clas
            ,item
            ,payTm
            ,note1
            ,note2
            ,inpId
            ,inpDttm
            ,updId
            ,updDttm
        )
        SELECT
            #{corpCd}
            ,#{busiCd}
            ,#{estCd}
            ,#{projCd}
            ,(SELECT
            CONCAT(DATE_FORMAT(now(),'%Y%m'),LPAD(IFNULL(SUBSTR(MAX(salCd*1)+1,7,12),0),5,'0'))
            FROM TB_YEONGEOB_SAL_LIST
            WHERE corpCd = #{corpCd}
                AND DATE_FORMAT(now(),'%Y%m') = SUBSTR(salCd,1,6))
            ,#{deadDivi}
            ,#{projDivi}
            ,#{sccDivi}
            ,#{salDivi}
            ,#{estDt}
            ,#{validDt}
            ,#{cntDt}
            ,#{dueDt}
            ,#{endDt}
            ,#{salDt}
            ,#{custCd}
            ,#{manCd}
            ,#{depaCd}
            ,#{supAmt2}
            ,#{vatAmt2}
            ,#{totAmt2}
            ,#{supAmt3}
            ,#{vatAmt3}
            ,#{totAmt3}
            ,#{clas}
            ,#{item}
            ,#{payTm}
            ,#{note1}
            ,#{note2}
            ,#{userId}
            ,now()
            ,#{userId}
            ,now()
    </insert>

    <update id="updateSalMgtList" parameterType="hashMap">
        UPDATE /* updateSalMgtList */
        TB_YEONGEOB_SAL_LIST SET
            deadDivi = #{deadDivi}
            ,projDivi = #{projDivi}
            ,sccDivi = #{sccDivi}
            ,salDivi = #{salDivi}
            ,estDt = #{estDt}
            ,validDt = #{validDt}
            ,cntDt = #{cntDt}
            ,dueDt = #{dueDt}
            ,endDt = #{endDt}
            ,salDt = #{salDt}
            ,custCd = #{custCd}
            ,projCd = #{projCd}
            ,manCd = #{manCd}
            ,depaCd = #{depaCd}
            ,supAmt2 = #{supAmt2}
            ,vatAmt2 = #{vatAmt2}
            ,totAmt2 = #{totAmt2}
            ,supAmt3 = #{supAmt3}
            ,vatAmt3 = #{vatAmt3}
            ,totAmt3 = #{totAmt3}
            ,clas = #{clas}
            ,item = #{item}
            ,payTm = #{payTm}
            ,note1 = #{note1}
            ,note2 = #{note2}
            ,updId = #{userId}
            ,updDttm = now()
        WHERE corpCd = #{corpCd}
          AND salCd = #{salCd}
    </update>

    <delete id="deleteSalMgtList"  parameterType="hashMap">
        DELETE /* deleteSalMgtList */
        FROM TB_YEONGEOB_SAL_LIST
        WHERE corpCd = #{corpCd}
          AND salCd = #{salCd}
    </delete>

    <delete id="deleteSalEmailList"  parameterType="hashMap">
        DELETE /*deleteSalEmailList*/
        FROM tb_yeongeob_sal_email_list
        WHERE corpCd = #{corpCd}
          AND salCd = #{salCd}
        <if test="seq != null and !seq.equals('')">
          AND seq = #{seq}
        </if>
    </delete>

    <insert id="aProjMgtList" parameterType="hashMap">
        INSERT INTO /* aProjMgtList */
            TB_YEONGEOB_SAL_LIST(
                                 corpCd
                                ,busiCd
                                ,estCd
                                ,projCd
                                ,salCd
                                ,deadDivi
                                ,projDivi
                                ,sccDivi
                                ,estDt
                                ,validDt
                                ,cntDt
                                ,initiateDt
                                ,dueDt
                                ,endDt
                                ,salDt
                                ,custCd
                                ,manCd
                                ,depaCd
                                ,supAmt2
                                ,vatAmt2
                                ,totAmt2
                                ,supAmt3
                                ,vatAmt3
                                ,totAmt3
                                ,clas
                                ,item
                                ,payTm
                                ,note1
                                ,note2
                                ,inpId
                                ,inpDttm
                                ,updId
                                ,updDttm
        )
        SELECT
            T1.corpCd
             ,T1.busiCd
             ,T1.estCd
             ,T1.projCd
             ,(SELECT
                   CONCAT(DATE_FORMAT(now(),'%Y%m'),LPAD(IFNULL(SUBSTR(MAX(salCd*1)+1,7,12),0),5,'0'))
               FROM TB_YEONGEOB_SAL_LIST
               WHERE corpCd = #{corpCd}
                 AND DATE_FORMAT(now(),'%Y%m') = SUBSTR(salCd,1,6))
             ,T1.deadDivi
             ,T1.projDivi
             ,T1.sccDivi
             ,T1.estDt
             ,T1.validDt
             ,T1.cntDt
             ,T1.initiateDt
             ,T1.dueDt
             ,T1.endDt
             ,DATE_FORMAT(now(), '%Y%m%d')
             ,T1.custCd
             ,T1.manCd
             ,T1.depaCd
             ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.supAmt2 ELSE SUM(T2.supAmt2) END AS supAmt2
             ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.vatAmt2 ELSE SUM(T2.vatAmt2) END AS vatAmt2
             ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.totAmt2 ELSE SUM(T2.totAmt2) END AS totAmt2
             ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.supAmt3 ELSE SUM(T2.supAmt3) END AS supAmt3
             ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.vatAmt3 ELSE SUM(T2.vatAmt3) END AS vatAmt3
             ,CASE WHEN COUNT(T2.corpCd) = 0 THEN T1.totAmt3 ELSE SUM(T2.totAmt3) END AS totAmt3
             ,T1.clas
             ,T1.item
             ,T1.payTm
             ,''
             ,''
             ,#{userId}
             ,now()
             ,#{userId}
             ,now()
          FROM TB_PROJECT_LIST T1 LEFT JOIN TB_PROJECT_ITEM_LIST T2
            ON T1.corpCd = T2.corpCd
           AND T1.projCd = T2.projCd
         WHERE T1.corpCd = #{corpCd}
           AND T1.projCd = #{projCd}
         GROUP BY T1.corpCd, T1.projCd
    </insert>

    <update id="deadLineSalMgtList" parameterType="hashMap">
        UPDATE /*deadLineSalMgtList*/
            TB_YEONGEOB_SAL_LIST SET
            deadDivi = #{deadDivi}
        WHERE corpCd = #{corpCd}
          AND salCd = #{salCd}
    </update>
</mapper>